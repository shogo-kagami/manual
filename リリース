
prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ export HTTPS_PROXY=http://10.0.20.11:8080
export https_proxy=http://10.0.20.11:8080

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ cd ~

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ pwd
/c/Users/prod.shogo.kagami

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ rm -rf deploy_20250724/

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ cd ~

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ pwd
/c/Users/prod.shogo.kagami

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ mkdir deploy_20250724

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~ (main)
$ cd deploy_20250724

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724 (main)
$ pwd
/c/Users/prod.shogo.kagami/deploy_20250724

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724 (main)
$ git clone https://github.com/sbintuitions/reimei_RAG
Cloning into 'reimei_RAG'...
remote: Enumerating objects: 8442, done.
remote: Counting objects: 100% (1031/1031), done.
remote: Compressing objects: 100% (306/306), done.
remote: Total 8442 (delta 898), reused 725 (delta 725), pack-reused 7411 (from 3)
Receiving objects: 100% (8442/8442), 52.67 MiB | 19.31 MiB/s, done.
Resolving deltas: 100% (3816/3816), done.

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724 (main)
$ cd reimei_RAG/terraform/environments_ray/prod

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ pwd
/c/Users/prod.shogo.kagami/deploy_20250724/reimei_RAG/terraform/environments_ray/prod

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ aws configure sso
SSO session name (Recommended): prod
Attempting to automatically open the SSO authorization page in your default browser.
If the browser does not open or you wish to use a different device to authorize this request, open the following URL:

https://oidc.ap-northeast-1.amazonaws.com/authorize?response_type=code&client_id=eL-HmGsmAsGra8cO-lvGmWFwLW5vcnRoZWFzdC0x&redirect_uri=http%3A%2F%2F127.0.0.1%3A50279%2Foauth%2Fcallback&state=e4d1f279-d015-413a-89bf-a2348e779805&code_challenge_method=S256&scopes=sso%3Aaccount%3Aaccess&code_challenge=0DgWBNHp5tNBUwjIkrW59pMjzN9dXxgKtA05TYEmYO4
There are 2 AWS accounts available to you.
Using the account ID 050451382758
The only role available to you is: AWSAdministratorAccess
Using the role name "AWSAdministratorAccess"
Default client Region [None]:
CLI default output format (json if not specified) [None]:
Profile name [AWSAdministratorAccess-050451382758]:
To use this profile, specify the profile name using --profile, as shown:

aws sts get-caller-identity --profile AWSAdministratorAccess-050451382758

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ export AWS_PROFILE=AWSAdministratorAccess-050451382758

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ aws sso login
Attempting to automatically open the SSO authorization page in your default browser.
If the browser does not open or you wish to use a different device to authorize this request, open the following URL:

https://oidc.ap-northeast-1.amazonaws.com/authorize?response_type=code&client_id=eL-HmGsmAsGra8cO-lvGmWFwLW5vcnRoZWFzdC0x&redirect_uri=http%3A%2F%2F127.0.0.1%3A50304%2Foauth%2Fcallback&state=e2a3d5e0-1cfe-4c06-8d09-7c375dda95c4&code_challenge_method=S256&scopes=sso%3Aaccount%3Aaccess&code_challenge=U2ad468_7Dn6wOxnHeVCsGO_756jN7g0F4effvnw9Cw
Successfully logged into Start URL: https://d-95675fea1b.awsapps.com/start/#

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ terraform init
Initializing the backend...

Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.
Initializing modules...
- ec2_instance_ray_head in ..\..\modules\ec2-instance
Initializing provider plugins...
- Reusing previous version of hashicorp/aws from the dependency lock file
- Reusing previous version of hashicorp/cloudinit from the dependency lock file
- Installing hashicorp/aws v5.93.0...
- Installed hashicorp/aws v5.93.0 (signed by HashiCorp)
- Installing hashicorp/cloudinit v2.3.7...
- Installed hashicorp/cloudinit v2.3.7 (signed by HashiCorp)
Terraform has made some changes to the provider dependency selections recorded
in the .terraform.lock.hcl file. Review those changes and commit them to your
version control system if they represent changes you intended to make.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ terraform plan
data.aws_ecr_image.cpu: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private01: Reading...
data.aws_security_group.reimei_rag_sg_relay_subnet: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay03: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private03: Reading...
data.aws_security_group.reimei_rag_sg_lb_from_ext: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private02: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay01: Reading...
data.aws_vpc.reimei_rag_main_vpc: Reading...
aws_s3_bucket.app_config: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-config]
data.aws_security_group.reimei_rag_sg_relay_subnet: Read complete after 0s [id=sg-081ae7e5679bbb12f]
data.aws_subnet.reimei_rag_vpc_subnet_relay02: Reading...
data.aws_security_group.reimei_rag_sg_lb_from_ext: Read complete after 0s [id=sg-0d2018e3f8628f571]
module.ec2_instance_ray_head.data.aws_ssm_parameter.al2023: Reading...
data.aws_ecr_image.cpu: Read complete after 0s [id=sha256:37efa824c8c85f2ff3190cc2580508eb8e3ce45a58ab2010d78601e2ab4167bd]
module.ec2_instance_ray_head.aws_iam_role.ec2_role: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role]
data.aws_subnet.reimei_rag_vpc_subnet_relay01: Read complete after 0s [id=subnet-069e61778a428e032]
data.aws_subnet.reimei_rag_vpc_subnet_private01: Read complete after 0s [id=subnet-0f352bd385624c1d6]
data.aws_subnet.reimei_rag_vpc_subnet_private02: Read complete after 0s [id=subnet-051ac932c7f0b27c6]
data.aws_subnet.reimei_rag_vpc_subnet_relay03: Read complete after 0s [id=subnet-0a1d36335207cb4f4]
data.aws_subnet.reimei_rag_vpc_subnet_private03: Read complete after 0s [id=subnet-07a1e2ac6b7f74854]
module.ec2_instance_ray_head.aws_cloudwatch_log_group.ec2_logs: Refreshing state... [id=/ec2/reimei-engine-ray-prd/llm-serve/ec2-instance]
aws_lb.nlb_for_ext: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:loadbalancer/net/reimei-engine-ray-prd-nlb4ext/a441913485f9e6bc]
module.ec2_instance_ray_head.data.aws_ssm_parameter.al2023: Read complete after 0s [id=/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64]
data.aws_subnet.reimei_rag_vpc_subnet_relay02: Read complete after 1s [id=subnet-07eaa5c2b02e5b427]
aws_lb.app: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:loadbalancer/app/reimei-engine-ray-prd/85dcab4412fc2f79]
aws_s3_bucket_versioning.app_config: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-config]
aws_s3_object.serve_config: Refreshing state... [id=ray-serve-config/latest.yaml]
data.cloudinit_config.init: Reading...
data.cloudinit_config.init: Read complete after 0s [id=4283831046]
aws_lb_listener.http: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener/app/reimei-engine-ray-prd/85dcab4412fc2f79/388091f4a55b26aa]
data.aws_vpc.reimei_rag_main_vpc: Read complete after 1s [id=vpc-07758e1658c4c2149]
aws_lb_target_group.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e]
aws_lb_target_group.ec2: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038]
aws_lb_listener.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener/net/reimei-engine-ray-prd-nlb4ext/a441913485f9e6bc/7f795aecae8d87a4]
aws_lb_listener_rule.ec2: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener-rule/app/reimei-engine-ray-prd/85dcab4412fc2f79/388091f4a55b26aa/19a78639181ef1a7]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.ssm_managed: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141396100000004]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141358300000003]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.cw_agent_managed: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153140829700000001]
module.ec2_instance_ray_head.aws_iam_instance_profile.ec2_profile: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-instance-profile]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141076600000002]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPullOnly"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141429900000005]
module.ec2_instance_ray_head.aws_instance.this: Refreshing state... [id=i-02f0129a075e6c2cd]
aws_lb_target_group_attachment.ec2[0]: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250703083120514800000002]
aws_lb_target_group_attachment.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250703083120605600000003]
aws_s3_object.ray_worker_config: Refreshing state... [id=ray-worker-config/latest.json]

Terraform used the selected providers to generate the following execution plan.
Resource actions are indicated with the following symbols:
  ~ update in-place
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # aws_lb_target_group_attachment.ec2[0] must be replaced
-/+ resource "aws_lb_target_group_attachment" "ec2" {
      ~ id               = "arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250703083120514800000002" -> (known after apply)
      ~ target_id        = "i-02f0129a075e6c2cd" -> (known after apply) # forces replacement
        # (2 unchanged attributes hidden)
    }

  # aws_lb_target_group_attachment.ray_dashboard must be replaced
-/+ resource "aws_lb_target_group_attachment" "ray_dashboard" {
      ~ id               = "arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250703083120605600000003" -> (known after apply)
      ~ target_id        = "i-02f0129a075e6c2cd" -> (known after apply) # forces replacement
        # (2 unchanged attributes hidden)
    }

  # aws_s3_object.serve_config will be updated in-place
  ~ resource "aws_s3_object" "serve_config" {
      ~ content                       = <<-EOT
            # https://docs.ray.io/en/latest/serve/production-guide/config.html
            proxy_location: HeadOnly

            http_options:
              host: 0.0.0.0
              port: 8008
              request_timeout_s: null
              keep_alive_timeout_s: 3620

            # https://docs.ray.io/en/latest/serve/monitoring.html#configure-serve-logging
            logging_config:
              log_level: INFO
              logs_dir: null # defaults to ray temp dir
              encoding: JSON
              enable_access_log: true

            applications:
              - name: llm-inference-app
                route_prefix: /
                import_path: llm_serve.app.builder:build_openai_app
                runtime_env:
                  env_vars:
                    # Ray Availabe environment variables:
                    # https://github.com/ray-project/ray/blob/ray-2.45.0/python/ray/_private/ray_constants.py
                    RAY_LOG_TO_DRIVER: "1"
                    RAY_LOG_TO_DRIVER_EVENT_LEVEL: "INFO"
                    # vLLM Availabe environment variables:
                    # https://docs.vllm.ai/en/v0.8.5.post1/serving/env_vars.html
                    VLLM_NO_USAGE_STATS: "1"
                    VLLM_CACHE_ROOT: "/lustre/applications/reimei-engine-llm-serve/.cache/vllm"
                args:
                  llm_server_configs:
                    - engine: vllm
                      engine_kwargs:
          -             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-06-23/sbint-2025-06-23-70b-sft/"
          +             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-07-14/sbint-2025-07-14-70b-sft/"
                        served_model_name:
          -               - "sbint-instruct-2025-06-23:70b-sft"
          +               - "sbint-instruct-2025-07-14:70b-sft"
                        tensor_parallel_size: 8
                        distributed_executor_backend: "mp"
                        override_generation_config:
                          repetition_penalty: 1.05
                          temperature: 0.7
                          top_p: 0.9
                      server_kwargs: {}
                      deployment_options:
          -             name: "sbint-instruct-2025-06-23:70b-sft"
          +             name: "sbint-instruct-2025-07-14:70b-sft"
                        ray_actor_options:
                          num_cpus: 128
                          num_gpus: 8
                        placement_group_bundles: [{"CPU": 128}, {"GPU": 8}]
                        placement_group_strategy: "STRICT_PACK"
                        num_replicas: auto
                        max_ongoing_requests: 128
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 24
                          max_replicas: 28
                    - engine: vllm
                      engine_kwargs:
          -             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-05-22/sbint-2025-05-22-70b-dpo/"
          +             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-06-23/sbint-2025-06-23-70b-sft/"
                        served_model_name:
          -               - "sbint-instruct-2025-05-22:70b-dpo"
          +               - "sbint-instruct-2025-06-23:70b-sft"
                        tensor_parallel_size: 8
                        distributed_executor_backend: "mp"
                        override_generation_config:
                          repetition_penalty: 1.05
                          temperature: 0.7
                          top_p: 0.9
                      server_kwargs: {}
                      deployment_options:
          -             name: "sbint-instruct-2025-05-22:70b-dpo"
          +             name: "sbint-instruct-2025-06-23:70b-sft"
                        ray_actor_options:
                          num_cpus: 128
                          num_gpus: 8
                        placement_group_bundles: [{"CPU": 128}, {"GPU": 8}]
                        placement_group_strategy: "STRICT_PACK"
                        num_replicas: auto
                        max_ongoing_requests: 128
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 1
                          max_replicas: 4
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/guardrail/sarashinaguard-7b-20250508/"
                        served_model_name:
                          - "sarashinaguard-7b-20250508"
                          - "sarashinaguard-v2.0.1"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashinaguard-7b-20250508"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 256
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 2
                          max_replicas: 16
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/reranker/sarashina2.2-0.5b-reranker-toy-0421/"
                        served_model_name:
                          - "sarashina2.2-0.5b-reranker-toy-0421"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashina2.2-0.5b-reranker-toy-0421"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 512
                        autoscaling_config:
                          target_ongoing_requests: 256
                          min_replicas: 2
                          max_replicas: 8
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/reranker/sarashina2.2-0.5b-reranker-toy-0523/"
                        served_model_name:
                          - "sarashina2.2-0.5b-reranker-toy-0523"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashina2.2-0.5b-reranker-toy-0523"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 512
                        autoscaling_config:
                          target_ongoing_requests: 256
                          min_replicas: 2
                          max_replicas: 8
                  deployment_options:
                    name: llm_inference_app
                    ray_actor_options:
                      num_cpus: 1
                      accelerator_type: H100
                    num_replicas: auto
                    max_ongoing_requests: 1000
                    autoscaling_config:
                      target_ongoing_requests: 16
                      min_replicas: 64
                      max_replicas: 128
        EOT
      ~ etag                          = "feb71253c6de0b1828da97a7a9d4b4f6" -> "15f095db08fe64a2f6e6fef143d34a3b"
        id                            = "ray-serve-config/latest.yaml"
        tags                          = {}
      ~ version_id                    = "KcjiUz1sKF1AFhhd2b1vmBWah3HNf12M" -> (known after apply)
        # (23 unchanged attributes hidden)
    }

  # module.ec2_instance_ray_head.aws_instance.this must be replaced
-/+ resource "aws_instance" "this" {
      ~ ami                                  = (sensitive value) # forces replacement
      ~ arn                                  = "arn:aws:ec2:ap-northeast-1:050451382758:instance/i-02f0129a075e6c2cd" -> (known after apply)
      ~ associate_public_ip_address          = false -> (known after apply)
      ~ availability_zone                    = "ap-northeast-1a" -> (known after apply)
      ~ cpu_core_count                       = 2 -> (known after apply)
      ~ cpu_threads_per_core                 = 2 -> (known after apply)
      ~ disable_api_stop                     = false -> (known after apply)
      ~ disable_api_termination              = false -> (known after apply)
      ~ ebs_optimized                        = false -> (known after apply)
      + enable_primary_ipv6                  = (known after apply)
      - hibernation                          = false -> null
      + host_id                              = (known after apply)
      + host_resource_group_arn              = (known after apply)
      ~ id                                   = "i-02f0129a075e6c2cd" -> (known after apply)
      ~ instance_initiated_shutdown_behavior = "stop" -> (known after apply)
      + instance_lifecycle                   = (known after apply)
      ~ instance_state                       = "running" -> (known after apply)
      ~ ipv6_address_count                   = 0 -> (known after apply)
      ~ ipv6_addresses                       = [] -> (known after apply)
      + key_name                             = (known after apply)
      ~ monitoring                           = false -> (known after apply)
      + outpost_arn                          = (known after apply)
      + password_data                        = (known after apply)
      + placement_group                      = (known after apply)
      ~ placement_partition_number           = 0 -> (known after apply)
      ~ primary_network_interface_id         = "eni-0b1b9a815b38d668b" -> (known after apply)
      ~ private_dns                          = "ip-10-121-129-2.ap-northeast-1.compute.internal" -> (known after apply)
      + public_dns                           = (known after apply)
      + public_ip                            = (known after apply)
      ~ secondary_private_ips                = [] -> (known after apply)
      ~ security_groups                      = [] -> (known after apply)
      + spot_instance_request_id             = (known after apply)
        tags                                 = {
            "Name" = "reimei-engine-ray-prd-llm-serve"
        }
      ~ tenancy                              = "default" -> (known after apply)
      + user_data_base64                     = (known after apply)
        # (10 unchanged attributes hidden)

      ~ capacity_reservation_specification (known after apply)
      - capacity_reservation_specification {
          - capacity_reservation_preference = "open" -> null
        }

      ~ cpu_options (known after apply)
      - cpu_options {
          - core_count       = 2 -> null
          - threads_per_core = 2 -> null
            # (1 unchanged attribute hidden)
        }

      ~ ebs_block_device (known after apply)

      ~ enclave_options (known after apply)
      - enclave_options {
          - enabled = false -> null
        }

      ~ ephemeral_block_device (known after apply)

      ~ instance_market_options (known after apply)

      ~ maintenance_options (known after apply)
      - maintenance_options {
          - auto_recovery = "default" -> null
        }

      ~ metadata_options (known after apply)
      - metadata_options {
          - http_endpoint               = "enabled" -> null
          - http_protocol_ipv6          = "disabled" -> null
          - http_put_response_hop_limit = 2 -> null
          - http_tokens                 = "required" -> null
          - instance_metadata_tags      = "disabled" -> null
        }

      ~ network_interface (known after apply)

      ~ private_dns_name_options (known after apply)
      - private_dns_name_options {
          - enable_resource_name_dns_a_record    = false -> null
          - enable_resource_name_dns_aaaa_record = false -> null
          - hostname_type                        = "ip-name" -> null
        }

      ~ root_block_device {
          ~ device_name           = "/dev/xvda" -> (known after apply)
          ~ encrypted             = false -> (known after apply)
          ~ iops                  = 3000 -> (known after apply)
          + kms_key_id            = (known after apply)
          - tags                  = {} -> null
          ~ tags_all              = {
              - "Env"       = "prd"
              - "Project"   = "reimei-engine-ray"
              - "Terraform" = "true"
            } -> (known after apply)
          ~ throughput            = 125 -> (known after apply)
          ~ volume_id             = "vol-08c5d726957cfe0e2" -> (known after apply)
            # (3 unchanged attributes hidden)
        }
    }

Plan: 3 to add, 1 to change, 3 to destroy.

───────────────────────────────────────────────────────────────────────────────

Note: You didn't use the -out option to save this plan, so Terraform can't
guarantee to take exactly these actions if you run "terraform apply" now.

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$ terraform apply
data.aws_security_group.reimei_rag_sg_relay_subnet: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private01: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay01: Reading...
data.aws_ecr_image.cpu: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private02: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay02: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay03: Reading...
module.ec2_instance_ray_head.aws_cloudwatch_log_group.ec2_logs: Refreshing state... [id=/ec2/reimei-engine-ray-prd/llm-serve/ec2-instance]
module.ec2_instance_ray_head.aws_iam_role.ec2_role: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role]
aws_s3_bucket.app_config: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-config]
data.aws_subnet.reimei_rag_vpc_subnet_private03: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_relay02: Read complete after 0s [id=subnet-07eaa5c2b02e5b427]
data.aws_vpc.reimei_rag_main_vpc: Reading...
data.aws_subnet.reimei_rag_vpc_subnet_private01: Read complete after 0s [id=subnet-0f352bd385624c1d6]
data.aws_security_group.reimei_rag_sg_relay_subnet: Read complete after 0s [id=sg-081ae7e5679bbb12f]
data.aws_subnet.reimei_rag_vpc_subnet_private02: Read complete after 0s [id=subnet-051ac932c7f0b27c6]
data.aws_subnet.reimei_rag_vpc_subnet_relay01: Read complete after 0s [id=subnet-069e61778a428e032]
data.aws_subnet.reimei_rag_vpc_subnet_relay03: Read complete after 0s [id=subnet-0a1d36335207cb4f4]
module.ec2_instance_ray_head.data.aws_ssm_parameter.al2023: Reading...
data.aws_security_group.reimei_rag_sg_lb_from_ext: Reading...
aws_lb.app: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:loadbalancer/app/reimei-engine-ray-prd/85dcab4412fc2f79]
data.aws_ecr_image.cpu: Read complete after 0s [id=sha256:37efa824c8c85f2ff3190cc2580508eb8e3ce45a58ab2010d78601e2ab4167bd]
data.aws_subnet.reimei_rag_vpc_subnet_private03: Read complete after 0s [id=subnet-07a1e2ac6b7f74854]
data.aws_security_group.reimei_rag_sg_lb_from_ext: Read complete after 0s [id=sg-0d2018e3f8628f571]
aws_lb.nlb_for_ext: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:loadbalancer/net/reimei-engine-ray-prd-nlb4ext/a441913485f9e6bc]
module.ec2_instance_ray_head.data.aws_ssm_parameter.al2023: Read complete after 0s [id=/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64]
aws_s3_bucket_versioning.app_config: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-config]
aws_s3_object.serve_config: Refreshing state... [id=ray-serve-config/latest.yaml]
data.cloudinit_config.init: Reading...
data.cloudinit_config.init: Read complete after 0s [id=4283831046]
aws_lb_listener.http: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener/app/reimei-engine-ray-prd/85dcab4412fc2f79/388091f4a55b26aa]
data.aws_vpc.reimei_rag_main_vpc: Read complete after 0s [id=vpc-07758e1658c4c2149]
aws_lb_target_group.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e]
aws_lb_target_group.ec2: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038]
aws_lb_listener_rule.ec2: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener-rule/app/reimei-engine-ray-prd/85dcab4412fc2f79/388091f4a55b26aa/19a78639181ef1a7]
aws_lb_listener.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:listener/net/reimei-engine-ray-prd-nlb4ext/a441913485f9e6bc/7f795aecae8d87a4]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPullOnly"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141429900000005]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.ssm_managed: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141396100000004]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141076600000002]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.cw_agent_managed: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153140829700000001]
module.ec2_instance_ray_head.aws_iam_role_policy_attachment.custom_policies["arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"]: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-role-20250522153141358300000003]
module.ec2_instance_ray_head.aws_iam_instance_profile.ec2_profile: Refreshing state... [id=reimei-engine-ray-prd-llm-serve-instance-profile]
module.ec2_instance_ray_head.aws_instance.this: Refreshing state... [id=i-02f0129a075e6c2cd]
aws_lb_target_group_attachment.ray_dashboard: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250703083120605600000003]
aws_lb_target_group_attachment.ec2[0]: Refreshing state... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250703083120514800000002]
aws_s3_object.ray_worker_config: Refreshing state... [id=ray-worker-config/latest.json]

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  ~ update in-place
-/+ destroy and then create replacement

Terraform will perform the following actions:

  # aws_lb_target_group_attachment.ec2[0] must be replaced
-/+ resource "aws_lb_target_group_attachment" "ec2" {
      ~ id               = "arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250703083120514800000002" -> (known after apply)
      ~ target_id        = "i-02f0129a075e6c2cd" -> (known after apply) # forces replacement
        # (2 unchanged attributes hidden)
    }

  # aws_lb_target_group_attachment.ray_dashboard must be replaced
-/+ resource "aws_lb_target_group_attachment" "ray_dashboard" {
      ~ id               = "arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250703083120605600000003" -> (known after apply)
      ~ target_id        = "i-02f0129a075e6c2cd" -> (known after apply) # forces replacement
        # (2 unchanged attributes hidden)
    }

  # aws_s3_object.serve_config will be updated in-place
  ~ resource "aws_s3_object" "serve_config" {
      ~ content                       = <<-EOT
            # https://docs.ray.io/en/latest/serve/production-guide/config.html
            proxy_location: HeadOnly

            http_options:
              host: 0.0.0.0
              port: 8008
              request_timeout_s: null
              keep_alive_timeout_s: 3620

            # https://docs.ray.io/en/latest/serve/monitoring.html#configure-serve-logging
            logging_config:
              log_level: INFO
              logs_dir: null # defaults to ray temp dir
              encoding: JSON
              enable_access_log: true

            applications:
              - name: llm-inference-app
                route_prefix: /
                import_path: llm_serve.app.builder:build_openai_app
                runtime_env:
                  env_vars:
                    # Ray Availabe environment variables:
                    # https://github.com/ray-project/ray/blob/ray-2.45.0/python/ray/_private/ray_constants.py
                    RAY_LOG_TO_DRIVER: "1"
                    RAY_LOG_TO_DRIVER_EVENT_LEVEL: "INFO"
                    # vLLM Availabe environment variables:
                    # https://docs.vllm.ai/en/v0.8.5.post1/serving/env_vars.html
                    VLLM_NO_USAGE_STATS: "1"
                    VLLM_CACHE_ROOT: "/lustre/applications/reimei-engine-llm-serve/.cache/vllm"
                args:
                  llm_server_configs:
                    - engine: vllm
                      engine_kwargs:
          -             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-06-23/sbint-2025-06-23-70b-sft/"
          +             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-07-14/sbint-2025-07-14-70b-sft/"
                        served_model_name:
          -               - "sbint-instruct-2025-06-23:70b-sft"
          +               - "sbint-instruct-2025-07-14:70b-sft"
                        tensor_parallel_size: 8
                        distributed_executor_backend: "mp"
                        override_generation_config:
                          repetition_penalty: 1.05
                          temperature: 0.7
                          top_p: 0.9
                      server_kwargs: {}
                      deployment_options:
          -             name: "sbint-instruct-2025-06-23:70b-sft"
          +             name: "sbint-instruct-2025-07-14:70b-sft"
                        ray_actor_options:
                          num_cpus: 128
                          num_gpus: 8
                        placement_group_bundles: [{"CPU": 128}, {"GPU": 8}]
                        placement_group_strategy: "STRICT_PACK"
                        num_replicas: auto
                        max_ongoing_requests: 128
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 24
                          max_replicas: 28
                    - engine: vllm
                      engine_kwargs:
          -             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-05-22/sbint-2025-05-22-70b-dpo/"
          +             model: "/lustre/share/sbint_models/finetuned/release/sbint-2025-06-23/sbint-2025-06-23-70b-sft/"
                        served_model_name:
          -               - "sbint-instruct-2025-05-22:70b-dpo"
          +               - "sbint-instruct-2025-06-23:70b-sft"
                        tensor_parallel_size: 8
                        distributed_executor_backend: "mp"
                        override_generation_config:
                          repetition_penalty: 1.05
                          temperature: 0.7
                          top_p: 0.9
                      server_kwargs: {}
                      deployment_options:
          -             name: "sbint-instruct-2025-05-22:70b-dpo"
          +             name: "sbint-instruct-2025-06-23:70b-sft"
                        ray_actor_options:
                          num_cpus: 128
                          num_gpus: 8
                        placement_group_bundles: [{"CPU": 128}, {"GPU": 8}]
                        placement_group_strategy: "STRICT_PACK"
                        num_replicas: auto
                        max_ongoing_requests: 128
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 1
                          max_replicas: 4
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/guardrail/sarashinaguard-7b-20250508/"
                        served_model_name:
                          - "sarashinaguard-7b-20250508"
                          - "sarashinaguard-v2.0.1"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashinaguard-7b-20250508"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 256
                        autoscaling_config:
                          target_ongoing_requests: 2
                          min_replicas: 2
                          max_replicas: 16
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/reranker/sarashina2.2-0.5b-reranker-toy-0421/"
                        served_model_name:
                          - "sarashina2.2-0.5b-reranker-toy-0421"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashina2.2-0.5b-reranker-toy-0421"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 512
                        autoscaling_config:
                          target_ongoing_requests: 256
                          min_replicas: 2
                          max_replicas: 8
                    - engine: vllm
                      engine_kwargs:
                        model: "/lustre/share/sbint_models/reranker/sarashina2.2-0.5b-reranker-toy-0523/"
                        served_model_name:
                          - "sarashina2.2-0.5b-reranker-toy-0523"
                      server_kwargs: {}
                      deployment_options:
                        name: "sarashina2.2-0.5b-reranker-toy-0523"
                        ray_actor_options:
                          num_cpus: 16
                          num_gpus: 1
                        num_replicas: auto
                        max_ongoing_requests: 512
                        autoscaling_config:
                          target_ongoing_requests: 256
                          min_replicas: 2
                          max_replicas: 8
                  deployment_options:
                    name: llm_inference_app
                    ray_actor_options:
                      num_cpus: 1
                      accelerator_type: H100
                    num_replicas: auto
                    max_ongoing_requests: 1000
                    autoscaling_config:
                      target_ongoing_requests: 16
                      min_replicas: 64
                      max_replicas: 128
        EOT
      ~ etag                          = "feb71253c6de0b1828da97a7a9d4b4f6" -> "15f095db08fe64a2f6e6fef143d34a3b"
        id                            = "ray-serve-config/latest.yaml"
        tags                          = {}
      ~ version_id                    = "KcjiUz1sKF1AFhhd2b1vmBWah3HNf12M" -> (known after apply)
        # (23 unchanged attributes hidden)
    }

  # module.ec2_instance_ray_head.aws_instance.this must be replaced
-/+ resource "aws_instance" "this" {
      ~ ami                                  = (sensitive value) # forces replacement
      ~ arn                                  = "arn:aws:ec2:ap-northeast-1:050451382758:instance/i-02f0129a075e6c2cd" -> (known after apply)
      ~ associate_public_ip_address          = false -> (known after apply)
      ~ availability_zone                    = "ap-northeast-1a" -> (known after apply)
      ~ cpu_core_count                       = 2 -> (known after apply)
      ~ cpu_threads_per_core                 = 2 -> (known after apply)
      ~ disable_api_stop                     = false -> (known after apply)
      ~ disable_api_termination              = false -> (known after apply)
      ~ ebs_optimized                        = false -> (known after apply)
      + enable_primary_ipv6                  = (known after apply)
      - hibernation                          = false -> null
      + host_id                              = (known after apply)
      + host_resource_group_arn              = (known after apply)
      ~ id                                   = "i-02f0129a075e6c2cd" -> (known after apply)
      ~ instance_initiated_shutdown_behavior = "stop" -> (known after apply)
      + instance_lifecycle                   = (known after apply)
      ~ instance_state                       = "running" -> (known after apply)
      ~ ipv6_address_count                   = 0 -> (known after apply)
      ~ ipv6_addresses                       = [] -> (known after apply)
      + key_name                             = (known after apply)
      ~ monitoring                           = false -> (known after apply)
      + outpost_arn                          = (known after apply)
      + password_data                        = (known after apply)
      + placement_group                      = (known after apply)
      ~ placement_partition_number           = 0 -> (known after apply)
      ~ primary_network_interface_id         = "eni-0b1b9a815b38d668b" -> (known after apply)
      ~ private_dns                          = "ip-10-121-129-2.ap-northeast-1.compute.internal" -> (known after apply)
      + public_dns                           = (known after apply)
      + public_ip                            = (known after apply)
      ~ secondary_private_ips                = [] -> (known after apply)
      ~ security_groups                      = [] -> (known after apply)
      + spot_instance_request_id             = (known after apply)
        tags                                 = {
            "Name" = "reimei-engine-ray-prd-llm-serve"
        }
      ~ tenancy                              = "default" -> (known after apply)
      + user_data_base64                     = (known after apply)
        # (10 unchanged attributes hidden)

      ~ capacity_reservation_specification (known after apply)
      - capacity_reservation_specification {
          - capacity_reservation_preference = "open" -> null
        }

      ~ cpu_options (known after apply)
      - cpu_options {
          - core_count       = 2 -> null
          - threads_per_core = 2 -> null
            # (1 unchanged attribute hidden)
        }

      ~ ebs_block_device (known after apply)

      ~ enclave_options (known after apply)
      - enclave_options {
          - enabled = false -> null
        }

      ~ ephemeral_block_device (known after apply)

      ~ instance_market_options (known after apply)

      ~ maintenance_options (known after apply)
      - maintenance_options {
          - auto_recovery = "default" -> null
        }

      ~ metadata_options (known after apply)
      - metadata_options {
          - http_endpoint               = "enabled" -> null
          - http_protocol_ipv6          = "disabled" -> null
          - http_put_response_hop_limit = 2 -> null
          - http_tokens                 = "required" -> null
          - instance_metadata_tags      = "disabled" -> null
        }

      ~ network_interface (known after apply)

      ~ private_dns_name_options (known after apply)
      - private_dns_name_options {
          - enable_resource_name_dns_a_record    = false -> null
          - enable_resource_name_dns_aaaa_record = false -> null
          - hostname_type                        = "ip-name" -> null
        }

      ~ root_block_device {
          ~ device_name           = "/dev/xvda" -> (known after apply)
          ~ encrypted             = false -> (known after apply)
          ~ iops                  = 3000 -> (known after apply)
          + kms_key_id            = (known after apply)
          - tags                  = {} -> null
          ~ tags_all              = {
              - "Env"       = "prd"
              - "Project"   = "reimei-engine-ray"
              - "Terraform" = "true"
            } -> (known after apply)
          ~ throughput            = 125 -> (known after apply)
          ~ volume_id             = "vol-08c5d726957cfe0e2" -> (known after apply)
            # (3 unchanged attributes hidden)
        }
    }

Plan: 3 to add, 1 to change, 3 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

aws_lb_target_group_attachment.ec2[0]: Destroying... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250703083120514800000002]
aws_lb_target_group_attachment.ray_dashboard: Destroying... [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250703083120605600000003]
aws_s3_object.serve_config: Modifying... [id=ray-serve-config/latest.yaml]
aws_lb_target_group_attachment.ec2[0]: Destruction complete after 1s
aws_lb_target_group_attachment.ray_dashboard: Destruction complete after 1s
module.ec2_instance_ray_head.aws_instance.this: Destroying... [id=i-02f0129a075e6c2cd]
aws_s3_object.serve_config: Modifications complete after 1s [id=ray-serve-config/latest.yaml]
module.ec2_instance_ray_head.aws_instance.this: Still destroying... [id=i-02f0129a075e6c2cd, 00m10s elapsed]
module.ec2_instance_ray_head.aws_instance.this: Still destroying... [id=i-02f0129a075e6c2cd, 00m20s elapsed]
module.ec2_instance_ray_head.aws_instance.this: Still destroying... [id=i-02f0129a075e6c2cd, 00m30s elapsed]
module.ec2_instance_ray_head.aws_instance.this: Still destroying... [id=i-02f0129a075e6c2cd, 00m40s elapsed]
module.ec2_instance_ray_head.aws_instance.this: Destruction complete after 40s
module.ec2_instance_ray_head.aws_instance.this: Creating...
module.ec2_instance_ray_head.aws_instance.this: Still creating... [00m10s elapsed]
module.ec2_instance_ray_head.aws_instance.this: Creation complete after 13s [id=i-0bed23d0c7fdf9fc9]
aws_lb_target_group_attachment.ray_dashboard: Creating...
aws_lb_target_group_attachment.ec2[0]: Creating...
aws_lb_target_group_attachment.ec2[0]: Creation complete after 0s [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-llm-serve/863bf5dc8c3d5038-20250724094020833500000002]
aws_lb_target_group_attachment.ray_dashboard: Creation complete after 0s [id=arn:aws:elasticloadbalancing:ap-northeast-1:050451382758:targetgroup/reimei-engine-ray-prd-dashboard/3e3e746bbf94502e-20250724094020912000000003]

Apply complete! Resources: 3 added, 1 changed, 3 destroyed.

prod.shogo.kagami@VSOC-DESKTOP01 MINGW64 ~/deploy_20250724/reimei_RAG/terraform/environments_ray/prod (main)
$
